# Docker Compose Example for Qolsys Gateway
#
# This example includes:
# - Health checks
# - Resource limits
# - Logging configuration
# - Volume mounts for optional YAML config
#
# Note: This assumes you have an external MQTT broker running.
# The MQTT_HOST should point to your broker (e.g., your Home Assistant instance
# or a dedicated MQTT broker running elsewhere).

version: '3.8'

services:
  # Qolsys Gateway
  qolsysgw:
    image: ghcr.io/donhoffman/qolsysgw-container:latest
    container_name: qolsysgw
    restart: unless-stopped

    # Environment variables (or use env_file: .env)
    environment:
      # Required - Panel configuration
      QOLSYS_PANEL_HOST: "${QOLSYS_PANEL_HOST:-192.168.1.100}"
      QOLSYS_PANEL_TOKEN: "${QOLSYS_PANEL_TOKEN}"

      # Required - MQTT configuration
      # Point this to your MQTT broker (e.g., Home Assistant or dedicated broker)
      MQTT_HOST: "${MQTT_HOST:-192.168.1.50}"
      MQTT_PORT: "${MQTT_PORT:-1883}"
      MQTT_USERNAME: "${MQTT_USERNAME:-}"
      MQTT_PASSWORD: "${MQTT_PASSWORD:-}"

      # Optional - Panel settings
      QOLSYS_PANEL_USER_CODE: "${QOLSYS_PANEL_USER_CODE:-}"
      QOLSYS_PANEL_UNIQUE_ID: "${QOLSYS_PANEL_UNIQUE_ID:-qolsys_panel}"
      QOLSYS_PANEL_DEVICE_NAME: "${QOLSYS_PANEL_DEVICE_NAME:-Qolsys Panel}"

      # Optional - Arming configuration
      QOLSYS_ARM_AWAY_EXIT_DELAY: "${QOLSYS_ARM_AWAY_EXIT_DELAY:-}"
      QOLSYS_ARM_STAY_EXIT_DELAY: "${QOLSYS_ARM_STAY_EXIT_DELAY:-}"
      QOLSYS_ARM_AWAY_BYPASS: "${QOLSYS_ARM_AWAY_BYPASS:-}"
      QOLSYS_ARM_STAY_BYPASS: "${QOLSYS_ARM_STAY_BYPASS:-}"

      # Optional - Home Assistant configuration
      HA_DISCOVERY_PREFIX: "${HA_DISCOVERY_PREFIX:-homeassistant}"
      HA_CHECK_USER_CODE: "${HA_CHECK_USER_CODE:-true}"
      HA_CODE_ARM_REQUIRED: "${HA_CODE_ARM_REQUIRED:-false}"
      HA_CODE_DISARM_REQUIRED: "${HA_CODE_DISARM_REQUIRED:-false}"

      # Optional - Logging
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"

    # Optional: Mount YAML config file
    # volumes:
    #   - ./qolsysgw.yaml:/app/config.yaml:ro

    # Use host networking for easier access to local network devices
    # Alternatively, use bridge networking if your MQTT broker is accessible
    network_mode: host

    # Health check - verifies the gateway process is running
    healthcheck:
      test: ["CMD", "/app/docker-healthcheck.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Usage:
#   docker compose up -d                  # Start the gateway
#   docker compose logs -f                # View logs
#   docker compose ps                     # Check service status
#   docker compose restart                # Restart gateway
#   docker compose down                   # Stop service
